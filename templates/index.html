<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Project Search</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background-color: #f4f7f6;
            color: #333;
            line-height: 1.6;
        }
        
        .header-footer {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-footer:last-of-type {
            margin-top: 30px;
            margin-bottom: 0;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo {
            width: 40px;
            height: 40px;
            background: #e74c3c;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 18px;
            color: white;
        }
        
        .company-info {
            font-size: 14px;
        }
        
        .copyright {
            font-size: 12px;
            opacity: 0.9;
        }

        h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-top: 30px;
        }

        form {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            display: grid;
            gap: 15px;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }
        
        /* Force specific fields to be on their own line */
        .full-width-field {
            grid-column: 1 / -1;
        }

        form label {
            display: flex;
            flex-direction: column;
            font-weight: bold;
            margin-bottom: 5px;
        }

        form input[type="text"],
        form select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }

        form button,
        form input[type="submit"] {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-top: 10px;
        }

        form button:hover,
        form input[type="submit"]:hover {
            background-color: #2980b9;
        }



        .error {
            color: red;
            background-color: #ffe5e5;
            border: 1px solid red;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            overflow: hidden;
        }

        th, td {
            padding: 12px 15px;
            border: 1px solid #e0e0e0;
            text-align: left;
        }

        th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 1;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        p {
            margin-top: 15px;
            font-style: italic;
            color: #555;
        }

        hr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.75), rgba(0, 0, 0, 0));
            margin: 40px 0;
        }

        .pagination {
            margin-top: 20px;
            text-align: center;
        }

        .pagination a, .pagination span {
            display: inline-block;
            padding: 8px 16px;
            margin: 0 4px;
            border: 1px solid #ddd;
            border-radius: 4px;
            text-decoration: none;
            color: #3498db;
            background-color: #fff;
            transition: background-color 0.3s, color 0.3s;
        }

        .pagination a:hover {
            background-color: #3498db;
            color: white;
        }

        .pagination span.current-page {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
            font-weight: bold;
        }

        .pagination span.disabled {
            color: #bbb;
            cursor: not-allowed;
        }
        .filter-form input[type="text"] {
            width: calc(100% - 10px); /* Adjust width for padding */
            padding: 5px;
            margin: 2px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        
        .filter-form input[type="date"] {
            padding: 3px;
            margin: 1px 0;
            box-sizing: border-box;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.8em;
        }
        .table-container {
            overflow-x: auto; /* Enable horizontal scrolling for tables */
        }

        /* Date range styling */
        #date_range_fields {
            grid-column: span 2;
        }
        
        #date_range_fields input[type="text"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }
        
        #date_range_fields span {
            font-weight: bold;
            color: #666;
        }

        /* Custom size fields styling */
        #custom_size_fields {
            grid-column: span 2;
            display: flex;
            gap: 15px;
            align-items: flex-end;
        }

        #custom_size_fields label {
            flex: 1 1 auto;
            min-width: 200px;
        }

        #custom_size_fields input[type="number"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
        }

        .full-width-row {
            grid-column: 1 / -1;
            width: 100%;
            display: flex;
            align-items: flex-end;
            margin-top: 10px;
        }

        /* Responsive adjustments */
                @media (max-width: 768px) {
            form {
                grid-template-columns: 1fr;
            }

            #date_range_fields {
                grid-column: span 1;
            }
            #custom_size_fields {
                grid-column: span 1;
                flex-direction: column;
            }
            #spatial_options_fields {
                grid-column: span 1;
                flex-direction: column;
                gap: 10px;
            }
            #percentage_inputs_fields {
                grid-column: span 1;
                flex-direction: column;
                gap: 10px;
            }
        }
        
        /* Spatial options styling */
        #spatial_options_fields {
            grid-column: span 2;
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-top: 10px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        
        #spatial_options_fields input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        
        #spatial_options_fields label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            font-weight: normal;
            white-space: nowrap;
        }
        
        /* Percentage inputs styling */
        #percentage_inputs_fields {
            grid-column: span 2;
            display: flex;
            gap: 20px;
            align-items: center;
            margin-top: 10px;
        }
        
        #percentage_inputs_fields input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1em;
            width: 120px;
            box-sizing: border-box;
        }
        
        #percentage_inputs_fields label {
            display: flex;
            align-items: center;
            margin-bottom: 0;
            font-weight: normal;
        }
        
        .percentage-input {
            display: none;
        }
        
        .overlap-percentage-input {
            display: none;
        }
        .center-query-btn {
            grid-column: 1 / -1;
            width: 100%;
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }
        .center-query-btn input[type="submit"] {
            min-width: 200px;
        }
        
        .center-query-btn button[type="button"] {
            min-width: 200px;
            background-color: #e74c3c;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            margin-left: 10px;
        }
        
        .center-query-btn button[type="button"]:hover {
            background-color: #c0392b;
        }
        
        /* Actions column styling */
        .actions-column {
            min-width: 120px;
        }
        
        .actions-column a {
            display: inline-block;
            margin: 2px 0;
            padding: 4px 8px;
            background-color: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-size: 0.9em;
        }
        
        .actions-column a:hover {
            background-color: #2980b9;
        }

        .actions-column form {
            display: inline;
            margin: 0;
            padding: 0;
        }
        .actions-column button[type="submit"] {
            display: inline-block;
            margin: 2px 0;
            padding: 4px 8px;
            background-color: #e74c3c;
            color: white;
            text-decoration: none;
            border-radius: 3px;
            font-size: 0.9em;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            vertical-align: middle;
        }
        .actions-column button[type="submit"]:hover {
            background-color: #c0392b;
        }
        
        /* Download section styling */
        .download-section {
            background-color: #ffffff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            border-left: 4px solid #3498db;
        }

        .download-section h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: none;
        }

        .download-section p {
            margin-bottom: 20px;
            color: #666;
            font-style: normal;
        }

        .download-btn {
            background-color: #27ae60;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .download-btn:hover {
            background-color: #219a52;
        }

        .download-btn:active {
            transform: translateY(1px);
        }

        .download-status {
            margin-top: 10px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            display: none;
        }

        .download-status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .download-status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }
    </style>
</head>
<body>
    <!-- Header with Logo and Copyright -->
    <div class="header-footer">
        <div class="logo-section">
            <div class="logo">
                <img src="{{ url_for('static', filename='rocket.jpg') }}" alt="Rocket Logo" style="width: 36px; height: 36px; object-fit: contain; border-radius: 50%; background: white;">
            </div>
            <div class="company-info">
                <strong>ARCgis PRO DataBase</strong><br>
                <span style="font-size: 11px;">◊§◊®◊ï◊ô◊ô◊ß◊ò ◊©◊ô◊û◊ï◊® ◊î◊ô◊ì◊¢ ◊©◊ú (◊†◊ï◊°◊ô◊£ ◊©◊ô◊™◊ê◊§◊©◊®)</span><br>
                <span class="copyright">@Rocket Team Production</span>
            </div>
        </div>
        <div class="copyright">
            Version 1.0 | Spatial Database Management System
        </div>
    </div>
    
    <!-- Download db_manager.pyt button -->
    <div class="download-section">
        <h3>ArcGIS Pro Tool</h3>
        <p>Download the ArcGIS Pro toolbox for exporting layouts with automatic database integration:</p>
        <button type="button" id="downloadDbManagerBtn" class="download-btn">
            üì• Download db_manager.pyt
        </button>
        <div id="downloadStatus" class="download-status"></div>
    </div>
    
    <h2>Project Search</h2>
    <form method="post" id="searchForm">
      <label>Bottom Left (XMin/YMin): <input name="bottom_left" type="text" placeholder="e.g., 10.5/20.1" value="{{ request.form.bottom_left if request.form.bottom_left else '' }}"></label>
      <label>Top Right (XMax/YMax): <input name="top_right" type="text" placeholder="e.g., 30.0/40.8" value="{{ request.form.top_right if request.form.top_right else '' }}"></label>
      <div id="relative_size_row" class="full-width-row">
        <label style="display: flex; align-items: center; gap: 10px;">
          <input name="relative_size" id="relative_size_checkbox" type="checkbox" value="1" {% if request.form.relative_size %}checked{% endif %} onchange="toggleRelativeSize()"> Intersection Range
        </label>
        <div id="relative_size_percentages" style="display: none; gap: 10px; align-items: center; margin-left: 20px;">
          <label style="margin-bottom:0;">From: <input name="relative_size_from" type="number" min="0" max="1000" step="0.1" placeholder="e.g., 10" value="{{ request.form.relative_size_from if request.form.relative_size_from else '' }}">%</label>
          <label style="margin-bottom:0; margin-left: 10px;">To: <input name="relative_size_to" type="number" min="0" max="1000" step="0.1" placeholder="e.g., 20" value="{{ request.form.relative_size_to if request.form.relative_size_to else '' }}">%</label>
        </div>
      </div>
      <label class="full-width-field">Project UUID: <input name="uuid" type="text" placeholder="e.g., a1b2c3d4-e5f6-7890-1234-567890abcdef" value="{{ request.form.uuid if request.form.uuid else '' }}"></label>
      <div style="grid-column: 1 / -1; display: block; width: 100%;">
        <div style="display: block; width: 100%; margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">User Name (Partial Search): 
            <input name="user_name_partial" type="text" placeholder="Type partial name to search (e.g., 'john' for 'john_doe')" value="{{ request.form.user_name_partial if request.form.user_name_partial else '' }}" style="display: block; width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; box-sizing: border-box; margin-top: 5px;">
          </label>
        </div>
        <div style="display: block; width: 100%; margin-bottom: 15px;">
          <label style="display: block; font-weight: bold; margin-bottom: 5px;">User Name (Exact Match):
            <select name="user_name" style="display: block; width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 1em; box-sizing: border-box; margin-top: 5px;">
              <option value=""></option>
              {% for name in user_names %}
                <option value="{{ name }}" {% if name in selected_user_names %}selected{% endif %}>{{ name }}</option>
              {% endfor %}
            </select>
          </label>
        </div>
      </div>
      <button type="button" onclick="addUserNameDropdown()">Add another exact match user name</button>
      <div class="full-width-row" id="paper_size_row">
        <label style="margin-bottom:0;">Paper Size:
          <select name="paper_size" id="paper_size_select" onchange="toggleCustomSize()">
            <option value="">Select Paper Size</option>
            <option value="A0 (Portrait)" {% if request.form.paper_size == 'A0 (Portrait)' %}selected{% endif %}>A0 (Portrait)</option>
            <option value="A0 (Landscape)" {% if request.form.paper_size == 'A0 (Landscape)' %}selected{% endif %}>A0 (Landscape)</option>
            <option value="A1 (Portrait)" {% if request.form.paper_size == 'A1 (Portrait)' %}selected{% endif %}>A1 (Portrait)</option>
            <option value="A1 (Landscape)" {% if request.form.paper_size == 'A1 (Landscape)' %}selected{% endif %}>A1 (Landscape)</option>
            <option value="A2 (Portrait)" {% if request.form.paper_size == 'A2 (Portrait)' %}selected{% endif %}>A2 (Portrait)</option>
            <option value="A2 (Landscape)" {% if request.form.paper_size == 'A2 (Landscape)' %}selected{% endif %}>A2 (Landscape)</option>
            <option value="A3 (Portrait)" {% if request.form.paper_size == 'A3 (Portrait)' %}selected{% endif %}>A3 (Portrait)</option>
            <option value="A3 (Landscape)" {% if request.form.paper_size == 'A3 (Landscape)' %}selected{% endif %}>A3 (Landscape)</option>
            <option value="A4 (Portrait)" {% if request.form.paper_size == 'A4 (Portrait)' %}selected{% endif %}>A4 (Portrait)</option>
            <option value="A4 (Landscape)" {% if request.form.paper_size == 'A4 (Landscape)' %}selected{% endif %}>A4 (Landscape)</option>
            <option value="A5 (Portrait)" {% if request.form.paper_size == 'A5 (Portrait)' %}selected{% endif %}>A5 (Portrait)</option>
            <option value="A5 (Landscape)" {% if request.form.paper_size == 'A5 (Landscape)' %}selected{% endif %}>A5 (Landscape)</option>
            <option value="B0 (Portrait)" {% if request.form.paper_size == 'B0 (Portrait)' %}selected{% endif %}>B0 (Portrait)</option>
            <option value="B0 (Landscape)" {% if request.form.paper_size == 'B0 (Landscape)' %}selected{% endif %}>B0 (Landscape)</option>
            <option value="custom" {% if request.form.paper_size == 'custom' %}selected{% endif %}>Custom Size</option>
          </select>
        </label>
        <div id="custom_size_fields" style="display: none; margin-left: 15px; flex: 0 0 auto;">
          <label style="margin-bottom:0;">Custom Height (cm): <input name="custom_height" type="number" step="0.1" placeholder="e.g., 29.7" value="{{ request.form.custom_height if request.form.custom_height else '' }}"></label>
          <label style="margin-bottom:0; margin-left: 10px;">Custom Width (cm): <input name="custom_width" type="number" step="0.1" placeholder="e.g., 21.0" value="{{ request.form.custom_width if request.form.custom_width else '' }}"></label>
        </div>
      </div>
      <label>Scale: <input name="scale" type="text" placeholder="e.g., 1000" value="{{ request.form.scale if request.form.scale else '' }}"></label>
      <div id="date_range_fields">
        <label>Date Range:
          <div style="display: flex; gap: 10px; align-items: center;">
            <input name="date_from" type="text" placeholder="DD/MM/YYYY (e.g., 09/07/2025)" value="{{ request.form.date_from if request.form.date_from else '' }}" style="flex: 1;" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
            <span>to</span>
            <input name="date_to" type="text" placeholder="DD/MM/YYYY (e.g., 25/12/2025)" value="{{ request.form.date_to if request.form.date_to else '' }}" style="flex: 1;" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
          </div>
        </label>
      </div>
      <div class="center-query-btn">
        <input type="submit" value="Query">
        <button type="button" onclick="resetForm()">Reset Query</button>
      </div>
    </form>
    <script>
    function addUserNameDropdown() {
      var userNames = {{ user_names|tojson }};
      var button = document.querySelector('button[onclick="addUserNameDropdown()"]');
      
      var label = document.createElement('label');
      label.className = 'full-width-field';
      label.innerHTML = 'User Name (Exact Match): ';
      var select = document.createElement('select');
      select.name = 'user_name';
      var emptyOpt = document.createElement('option');
      emptyOpt.value = '';
      select.appendChild(emptyOpt);
      for (var i = 0; i < userNames.length; i++) {
        var opt = document.createElement('option');
        opt.value = userNames[i];
        opt.text = userNames[i];
        select.appendChild(opt);
      }
      label.appendChild(select);
      button.parentNode.insertBefore(label, button);
    }

    function toggleCustomSize() {
      var paperSizeSelect = document.getElementById('paper_size_select');
      var customFields = document.getElementById('custom_size_fields');
      
      if (paperSizeSelect.value === 'custom') {
        customFields.style.display = 'block';
      } else {
        customFields.style.display = 'none';
      }
    }

    function toggleRelativeSize() {
      var checkbox = document.getElementById('relative_size_checkbox');
      var percentDiv = document.getElementById('relative_size_percentages');
      if (checkbox && percentDiv) {
        if (checkbox.checked) {
          percentDiv.style.display = 'flex';
        } else {
          percentDiv.style.display = 'none';
        }
      }
    }

    function resetForm() {
      // Reset all form inputs
      document.getElementById('searchForm').reset();
      
      // Hide custom size fields
      document.getElementById('custom_size_fields').style.display = 'none';
      // Hide relative size percentages
      document.getElementById('relative_size_percentages').style.display = 'none';
      
      // Clear any additional user name dropdowns (keep only the first one)
      var userNameSelects = document.querySelectorAll('select[name="user_name"]');
      for (var i = 1; i < userNameSelects.length; i++) {
        userNameSelects[i].parentNode.remove();
      }
      
      // Reset the first user name dropdown
      if (userNameSelects.length > 0) {
        userNameSelects[0].value = '';
      }
      
      // Clear URL parameters and reload the page to reset everything
      window.location.href = window.location.pathname;
    }

    function copyPath(path) {
      // Create a temporary textarea element
      var textarea = document.createElement('textarea');
      textarea.value = path;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      
      // Select and copy the text
      textarea.select();
      document.execCommand('copy');
      
      // Remove the temporary element
      document.body.removeChild(textarea);
      
      // Show a brief notification
      var notification = document.createElement('div');
      notification.textContent = 'Path copied to clipboard!';
      notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 10px 15px; border-radius: 5px; z-index: 10000; font-size: 14px;';
      document.body.appendChild(notification);
      
      // Remove notification after 2 seconds
      setTimeout(function() {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 2000);
    }

    async function downloadDbManager() {
      const downloadBtn = document.getElementById('downloadDbManagerBtn');
      const statusDiv = document.getElementById('downloadStatus');
      
      if (downloadBtn) {
        downloadBtn.disabled = true;
        downloadBtn.textContent = '‚è≥ Downloading...';
      }
      
      if (statusDiv) {
        statusDiv.className = 'download-status';
        statusDiv.style.display = 'none';
      }
      
      try {
        const response = await fetch('/download/db_manager.pyt');
        
        if (response.ok) {
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'db_manager.pyt';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
          
          if (statusDiv) {
            statusDiv.textContent = '‚úÖ Download completed successfully!';
            statusDiv.className = 'download-status success';
            statusDiv.style.display = 'block';
          }
        } else {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `HTTP ${response.status}`);
        }
      } catch (error) {
        console.error('Download failed:', error);
        if (statusDiv) {
          statusDiv.textContent = `‚ùå Download failed: ${error.message}`;
          statusDiv.className = 'download-status error';
          statusDiv.style.display = 'block';
        }
      } finally {
        if (downloadBtn) {
          downloadBtn.disabled = false;
          downloadBtn.textContent = 'üì• Download db_manager.pyt';
        }
            }
    }

    // Function to get a URL parameter
    function getUrlParameter(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    };
    function applyProjectsTableFilters() {
        let filters = {
            projects_uuid_filter: document.querySelector('input[name="projects_uuid_filter"]').value,
            projects_project_name_filter: document.querySelector('input[name="projects_project_name_filter"]').value,
            projects_user_name_filter: document.querySelector('input[name="projects_user_name_filter"]').value,
            projects_date_filter: document.querySelector('input[name="projects_date_filter"]').value,
            projects_date_from_filter: document.querySelector('input[name="projects_date_from_filter"]').value,
            projects_date_to_filter: document.querySelector('input[name="projects_date_to_filter"]').value,
            projects_file_location_filter: document.querySelector('input[name="projects_file_location_filter"]').value,
            projects_paper_size_filter: document.querySelector('input[name="projects_paper_size_filter"]').value,
            projects_associated_scales_filter: document.querySelector('input[name="projects_associated_scales_filter"]').value // The new filter
        };
        let queryParams = new URLSearchParams(window.location.search);
        for (let key in filters) {
            if (filters[key]) {
                queryParams.set(key, filters[key]);
            } else {
                queryParams.delete(key);
            }
        }
        queryParams.delete('page'); // Reset page when filters change
        window.location.search = queryParams.toString();
    }
    // -----------------------------------------------------
    window.onload = function() {
      // Add download button event listener
      const downloadDbManagerBtn = document.getElementById('downloadDbManagerBtn');
      if (downloadDbManagerBtn) {
        downloadDbManagerBtn.addEventListener('click', downloadDbManager);
      }
      
      // Completely disable user name field manipulation to preserve partial search
      // Let Flask handle all form state naturally

      // Add hidden input for scroll position to each filter form
      const projectsFilterForm = document.getElementById('projectsFilterForm');
      if (projectsFilterForm) {
          let scrollInput = document.createElement('input');
          scrollInput.type = 'hidden';
          scrollInput.name = 'scroll_pos';
          scrollInput.id = 'projects_scroll_pos';
          projectsFilterForm.appendChild(scrollInput);

          projectsFilterForm.addEventListener('submit', function() {
              document.getElementById('projects_scroll_pos').value = window.scrollY;
          });
      }

      const areasFilterForm = document.getElementById('areasFilterForm');
      if (areasFilterForm) {
          let scrollInput = document.createElement('input');
          scrollInput.type = 'hidden';
          scrollInput.name = 'scroll_pos';
          scrollInput.id = 'areas_scroll_pos';
          areasFilterForm.appendChild(scrollInput);

          areasFilterForm.addEventListener('submit', function() {
              document.getElementById('areas_scroll_pos').value = window.scrollY;
          });
      }

      // Add event listeners to filter inputs for submitting on change (or enter key)
      document.querySelectorAll('.filter-input').forEach(input => {
        input.addEventListener('change', function() {
          // Ensure the hidden scroll input is updated before submission
          if (this.closest('form') && this.closest('form').id === 'projectsFilterForm') {
              document.getElementById('projects_scroll_pos').value = window.scrollY;
          } else if (this.closest('form') && this.closest('form').id === 'areasFilterForm') {
              document.getElementById('areas_scroll_pos').value = window.scrollY;
          }
          this.form.submit();
        });
        input.addEventListener('keypress', function(event) {
          if (event.key === 'Enter') {
            event.preventDefault(); // Prevent default Enter key behavior (form submission)
            // Ensure the hidden scroll input is updated before submission
            if (this.closest('form') && this.closest('form').id === 'projectsFilterForm') {
                document.getElementById('projects_scroll_pos').value = window.scrollY;
            } else if (this.closest('form') && this.closest('form').id === 'areasFilterForm') {
                document.getElementById('areas_scroll_pos').value = window.scrollY;
            }
            this.form.submit();
          }
        });
      });

      // Restore scroll position after the page loads
      const scroll_pos = getUrlParameter('scroll_pos');
      if (scroll_pos) {
          window.scrollTo(0, parseInt(scroll_pos));
      }

      // Initialize custom size fields state
      toggleCustomSize();
      toggleRelativeSize(); // Initialize relative size fields
    }
    </script>
    {% if error %}
      <p class="error">{{ error }}</p>
    {% endif %}
    {% if results is not none %}
      <h3>Project Results:</h3>
      {% if results %}
        <div class="table-container">
            <table border="1" cellpadding="5">
              <tr><th>UUID</th><th>Project Name</th><th>User Name</th><th>Date</th><th>File Location</th><th>Paper Size</th><th>Description</th><th>Associated Scales</th><th class="actions-column">Actions</th></tr>
              {% for proj in results %}
                {% if proj and proj.uuid %}
                <tr>
                  <td>{{ proj.uuid }}</td>
                  <td>{{ proj.project_name }}</td>
                  <td>{{ proj.user_name }}</td>
                  <td>{{ proj.date }}</td>
                  <td>{{ proj.file_location }}</td>
                  <td>{{ proj.paper_size }}</td>
                  <td>{{ proj.description }}</td>
                  <td>{{ proj.get('associated_scales', 'N/A') }}</td>
                  <td class="actions-column">
                    {% if proj.view_file_path %}
                      <a href="#" onclick="showFileModal('{{ url_for('view_file', rel_path=proj.view_file_path) }}','{{ proj.view_file_type }}'); return false">View</a>
                    {% else %}
                      <span>No file</span>
                    {% endif %}
                    <a href="#" onclick="copyPath('{{ proj.file_location.replace('\\', '\\\\')|safe }}'); return false" style="background-color: #27ae60;">Copy Path</a>
                    <form method="post" action="{{ url_for('delete_project', uuid=proj.uuid|e) }}" style="display:inline;" onsubmit="return confirm('Are you sure you want to delete this project?');"><button type="submit">Delete</button></form>
                  </td>
                </tr>
                {% endif %}
              {% endfor %}
            </table>
        </div>
      {% else %}
        <p>No matching projects found.</p>
      {% endif %}
    {% endif %}
    <hr>
    <h2>All Projects</h2>
    <div class="table-container">
        <form method="get" id="projectsFilterForm">
            <input type="hidden" name="page" value="{{ projects_current_page }}">
            <input type="hidden" name="per_page" value="{{ projects_per_page }}">
            <table border="1" cellpadding="5">
              <thead>
                <tr>
                  <th>UUID <br> <input type="text" name="projects_uuid_filter" class="filter-input" value="{{ projects_filters.uuid_filter }}" placeholder="Filter UUID"></th>
                  <th>Project Name <br> <input type="text" name="projects_project_name_filter" class="filter-input" value="{{ projects_filters.project_name_filter }}" placeholder="Filter Name"></th>
                  <th>User Name <br> <input type="text" name="projects_user_name_filter" class="filter-input" value="{{ projects_filters.user_name_filter }}" placeholder="Filter User"></th>
                  <th>Date <br> 
                    <input type="text" name="projects_date_filter" class="filter-input" value="{{ projects_filters.date_filter }}" placeholder="Filter Date" style="width: 100%; margin-bottom: 2px;">
                    <input type="text" name="projects_date_from_filter" class="filter-input" value="{{ projects_filters.date_from_filter }}" placeholder="DD/MM/YYYY" style="width: 48%; font-size: 0.8em;" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
                    <input type="text" name="projects_date_to_filter" class="filter-input" value="{{ projects_filters.date_to_filter }}" placeholder="DD/MM/YYYY" style="width: 48%; font-size: 0.8em; margin-left: 2%;" pattern="[0-9]{2}/[0-9]{2}/[0-9]{4}">
                  </th>
                  <th>File Location <br> <input type="text" name="projects_file_location_filter" class="filter-input" value="{{ projects_filters.file_location_filter }}" placeholder="Filter Location"></th>
                  <th>Paper Size <br> <input type="text" name="projects_paper_size_filter" class="filter-input" value="{{ projects_filters.paper_size_filter }}" placeholder="Filter Size"></th>
                  <th>Description</th>
                  <th>Associated Scales <br> <input type="text" name="projects_associated_scales_filter" class="filter-input" value="{{ projects_filters.associated_scales_filter }}" placeholder="Filter Scales"></th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for proj in projects %}
                  {% if proj and proj.uuid %}
                  <tr>
                    <td>{{ proj.uuid }}</td>
                    <td>{{ proj.project_name }}</td>
                    <td>{{ proj.user_name }}</td>
                    <td>{{ proj.date }}</td>
                    <td>{{ proj.file_location }}</td>
                    <td>{{ proj.paper_size }}</td>
                    <td>{{ proj.description }}</td>
				<td>{{ proj.get('associated_scales', 'N/A') }}</td> 
                    <td class="actions-column">
                      {% if proj.view_file_path %}
                        <a href="#" onclick="showFileModal('{{ url_for('view_file', rel_path=proj.view_file_path) }}','{{ proj.view_file_type }}'); return false">View</a>
                      {% else %}
                        <span>No file</span>
                      {% endif %}
                      <a href="#" onclick="copyPath('{{ proj.file_location.replace('\\', '\\\\')|safe }}'); return false" style="background-color: #27ae60;">Copy Path</a>
                    </td>
                  </tr>
                  {% endif %}
                {% endfor %}
              </tbody>
            </table>
        </form>
    </div>
    <div class="pagination">
        {% if projects_current_page > 1 %}
            <a href="{{ url_for('index', page=projects_current_page - 1, per_page=projects_per_page, **projects_filters) }}">Previous</a>
        {% else %}
            <span class="disabled">Previous</span>
        {% endif %}

        {% for p in range(1, projects_total_pages + 1) %}
            {% if p == projects_current_page %}
                <span class="current-page">{{ p }}</span>
            {% else %}
                <a href="{{ url_for('index', page=p, per_page=projects_per_page, **projects_filters) }}">{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if projects_current_page < projects_total_pages %}
            <a href="{{ url_for('index', page=projects_current_page + 1, per_page=projects_per_page, **projects_filters) }}">Next</a>
        {% else %}
            <span class="disabled">Next</span>
        {% endif %}
        <br>
        <label>Items per page:
            <select onchange="window.location.href = '{{ url_for('index', **projects_filters) }}' + '&per_page=' + this.value">
                {% for size in [5, 10, 20, 50] %}
                    <option value="{{ size }}" {% if projects_per_page == size %}selected{% endif %}>{{ size }}</option>
                {% endfor %}
            </select>
        </label>
    </div>

    <h2>All Areas</h2>
    <div class="table-container">
        <form method="get" id="areasFilterForm">
            <input type="hidden" name="areas_page" value="{{ areas_current_page }}">
            <input type="hidden" name="areas_per_page" value="{{ areas_per_page }}">
            <table border="1" cellpadding="5">
              <thead>
                <tr>
                  <th>ID <br> <input type="text" name="areas_id_filter" class="filter-input" value="{{ areas_filters.id_filter }}" placeholder="Filter ID"></th>
                  <th>Project UUID <br> <input type="text" name="areas_project_id_filter" class="filter-input" value="{{ areas_filters.project_id_filter }}" placeholder="Filter UUID"></th>
                  <th>XMin <br> <input type="text" name="areas_xmin_filter" class="filter-input" value="{{ areas_filters.xmin_filter }}" placeholder="Filter XMin"></th>
                  <th>YMin <br> <input type="text" name="areas_ymin_filter" class="filter-input" value="{{ areas_filters.ymin_filter }}" placeholder="Filter YMin"></th>
                  <th>XMax <br> <input type="text" name="areas_xmax_filter" class="filter-input" value="{{ areas_filters.xmax_filter }}" placeholder="Filter XMax"></th>
                  <th>YMax <br> <input type="text" name="areas_ymax_filter" class="filter-input" value="{{ areas_filters.ymax_filter }}" placeholder="Filter YMax"></th>
                  <th>Scale <br> <input type="text" name="areas_scale_filter" class="filter-input" value="{{ areas_filters.scale_filter }}" placeholder="Filter Scale"></th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for area in areas %}
                <tr>
                  <td>{{ area.id }}</td>
                  <td>{{ area.project_id }}</td>
                  <td>{{ area.xmin }}</td>
                  <td>{{ area.ymin }}</td>
                  <td>{{ area.xmax }}</td>
                  <td>{{ area.ymax }}</td>
                  <td>{{ area.scale|string if area.scale else '' }}</td>
                  <td class="actions-column">
                    <a href="#" onclick="showFileModalOrNoFiles({{ area.project_all_files|tojson|safe }}); return false">View Project</a>
                    <a href="#" onclick="copyPath('{{ area.project_file_location.replace('\\', '\\\\')|safe }}'); return false" style="background-color: #27ae60;">Copy Project Path</a>
                    <button type="button" onclick="copyTopRight('{{ area.xmax }}', '{{ area.ymax }}')">Copy Top Right</button>
                    <button type="button" onclick="copyBottomLeft('{{ area.xmin }}', '{{ area.ymin }}')">Copy Bottom Left</button>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
        </form>
    </div>
    <div class="pagination">
        {% if areas_current_page > 1 %}
            <a href="{{ url_for('index', areas_page=areas_current_page - 1, areas_per_page=areas_per_page, **areas_filters) }}">Previous</a>
        {% else %}
            <span class="disabled">Previous</span>
        {% endif %}

        {% for p in range(1, areas_total_pages + 1) %}
            {% if p == areas_current_page %}
                <span class="current-page">{{ p }}</span>
            {% else %}
                <a href="{{ url_for('index', areas_page=p, areas_per_page=areas_per_page, **areas_filters) }}">{{ p }}</a>
            {% endif %}
        {% endfor %}

        {% if areas_current_page < areas_total_pages %}
            <a href="{{ url_for('index', areas_page=areas_current_page + 1, areas_per_page=areas_per_page, **areas_filters) }}">Next</a>
        {% else %}
            <span class="disabled">Next</span>
        {% endif %}
        <br>
        <label>Items per page:
            <select onchange="window.location.href = '{{ url_for('index', **areas_filters) }}' + '&areas_per_page=' + this.value">
                {% for size in [5, 10, 20, 50] %}
                    <option value="{{ size }}" {% if areas_per_page == size %}selected{% endif %}>{{ size }}</option>
                {% endfor %}
            </select>
        </label>
    </div>
    <div id="fileModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.8); z-index:9999; align-items:center; justify-content:center;">
      <div id="fileModalContent" style="position:relative; background:#fff; padding:20px; border-radius:8px; max-width:90vw; max-height:90vh; overflow:auto;">
        <button onclick="closeFileModal()" style="position:absolute; top:10px; right:10px; z-index:10000;">Close</button>
        <div id="fileModalBody"></div>
      </div>
    </div>
    
    <!-- Gallery Modal for All Files -->
    <div id="galleryModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.9); z-index:10000; align-items:center; justify-content:center;">
      <div id="galleryModalContent" style="position:relative; background:#fff; padding:20px; border-radius:8px; max-width:95vw; max-height:95vh; overflow:hidden; display:flex; flex-direction:column;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h3 id="galleryTitle" style="margin:0; color:#333;">Project Files</h3>
          <button onclick="closeGalleryModal()" style="background:#e74c3c; color:white; border:none; padding:8px 12px; border-radius:4px; cursor:pointer;">Close</button>
        </div>
        
        <div id="galleryContainer" style="flex:1; display:flex; align-items:center; justify-content:center; position:relative;">
          <!-- Navigation Arrows -->
          <button id="prevBtn" onclick="previousFile()" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.7); color:white; border:none; padding:15px 10px; border-radius:50%; cursor:pointer; font-size:18px; z-index:10001;">‚Äπ</button>
          <button id="nextBtn" onclick="nextFile()" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); background:rgba(0,0,0,0.7); color:white; border:none; padding:15px 10px; border-radius:50%; cursor:pointer; font-size:18px; z-index:10001;">‚Ä∫</button>
          
          <!-- File Display Area -->
          <div id="galleryFileDisplay" style="max-width:90%; max-height:80vh; display:flex; align-items:center; justify-content:center;">
            <!-- Content will be loaded here -->
          </div>
        </div>
        
        <!-- File Info and Navigation -->
        <div style="display:flex; justify-content:space-between; align-items:center; margin-top:15px; padding:10px; background:#f8f9fa; border-radius:4px;">
          <div id="fileInfo" style="flex:1;">
            <div id="fileName" style="font-weight:bold; margin-bottom:5px;"></div>
            <div id="fileDate" style="font-size:0.9em; color:#666;"></div>
          </div>
          <div id="fileCounter" style="text-align:center; font-weight:bold; color:#333;"></div>
          <div id="fileType" style="background:#3498db; color:white; padding:4px 8px; border-radius:12px; font-size:0.8em;"></div>
        </div>
      </div>
    </div>
    

    <script>
    function showFileModal(url, type) {
      console.log('[DEBUG] showFileModal called with url:', url, 'type:', type);
      var modal = document.getElementById('fileModal');
      var body = document.getElementById('fileModalBody');
      if (type === 'pdf') {
        body.innerHTML = '<iframe src="' + url + '" width="800" height="600" style="border:none;"></iframe>';
      } else if (type === 'img') {
        body.innerHTML = '<img src="' + url + '" style="max-width:80vw; max-height:80vh; display:block; margin:auto;" />';
      }
      modal.style.display = 'flex';
    }
    function closeFileModal() {
      var modal = document.getElementById('fileModal');
      var body = document.getElementById('fileModalBody');
      body.innerHTML = '';
      modal.style.display = 'none';
    }
    
    // Gallery modal variables
    var currentFiles = [];
    var currentFileIndex = 0;
    
    function showAllFilesModal(uuid) {
      try {
        // Get the clicked element and its data-files attribute
        var clickedElement = event.target;
        var filesJson = clickedElement.getAttribute('data-files');
        
        currentFiles = JSON.parse(filesJson);
        currentFileIndex = 0;
        
        var modal = document.getElementById('galleryModal');
        var title = document.getElementById('galleryTitle');
        
        title.textContent = 'Project Files (' + currentFiles.length + ' files)';
        modal.style.display = 'flex';
        
        displayCurrentFile();
      } catch (error) {
        console.error('Error parsing files data:', error);
        alert('Error loading files. Please try again.');
      }
    }
    
    function closeGalleryModal() {
      var modal = document.getElementById('galleryModal');
      modal.style.display = 'none';
      currentFiles = [];
      currentFileIndex = 0;
    }
    
    function displayCurrentFile() {
      if (currentFiles.length === 0) return;
      
      var file = currentFiles[currentFileIndex];
      var display = document.getElementById('galleryFileDisplay');
      var fileName = document.getElementById('fileName');
      var fileDate = document.getElementById('fileDate');
      var fileCounter = document.getElementById('fileCounter');
      var fileType = document.getElementById('fileType');
      var prevBtn = document.getElementById('prevBtn');
      var nextBtn = document.getElementById('nextBtn');
      
      // Update file info
      fileName.textContent = file.filename;
      fileDate.textContent = new Date(file.ctime * 1000).toLocaleString();
      fileCounter.textContent = (currentFileIndex + 1) + ' / ' + currentFiles.length;
      fileType.textContent = file.type.toUpperCase();
      
      // Update navigation buttons
      prevBtn.style.display = currentFileIndex > 0 ? 'block' : 'none';
      nextBtn.style.display = currentFileIndex < currentFiles.length - 1 ? 'block' : 'none';
      
      // Generate URL dynamically
      var fileUrl = '/view_file/' + encodeURIComponent(file.rel_path);
      
      // Display file content
      if (file.type === 'pdf') {
        display.innerHTML = '<iframe src="' + fileUrl + '" width="800" height="600" style="border:none; max-width:100%; max-height:100%;"></iframe>';
      } else {
        display.innerHTML = '<img src="' + fileUrl + '" style="max-width:100%; max-height:100%; object-fit:contain;" alt="' + file.filename + '">';
      }
    }
    
    function previousFile() {
      if (currentFileIndex > 0) {
        currentFileIndex--;
        displayCurrentFile();
      }
    }
    
    function nextFile() {
      if (currentFileIndex < currentFiles.length - 1) {
        currentFileIndex++;
        displayCurrentFile();
      }
    }
    
    // Keyboard navigation
    document.addEventListener('keydown', function(event) {
      if (document.getElementById('galleryModal').style.display === 'flex') {
        if (event.key === 'ArrowLeft') {
          previousFile();
        } else if (event.key === 'ArrowRight') {
          nextFile();
        } else if (event.key === 'Escape') {
          closeGalleryModal();
        }
      }
    });

    function showFileModalOrNoFiles(files) {
      console.log('[DEBUG] showFileModalOrNoFiles called with files:', files);
      if (!files || files.length === 0) {
        var modal = document.getElementById('fileModal');
        var body = document.getElementById('fileModalBody');
        body.innerHTML = '<div style="text-align:center; padding:40px; font-size:1.2em; color:#888;">No files available for this project.</div>';
        modal.style.display = 'flex';
      } else if (files.length === 1) {
        var file = files[0];
        var url = '/view_file/' + encodeURIComponent(file.rel_path);
        console.log('[DEBUG] Single file, url:', url, 'type:', file.type);
        showFileModal(url, file.type);
      } else {
        // Multiple files: open gallery
        currentFiles = files;
        currentFileIndex = 0;
        var modal = document.getElementById('galleryModal');
        var title = document.getElementById('galleryTitle');
        title.textContent = 'Project Files (' + currentFiles.length + ' files)';
        modal.style.display = 'flex';
        displayCurrentFile();
      }
    }

    function copyTopRight(xmax, ymax) {
      var str = xmax + '/' + ymax;
      var textarea = document.createElement('textarea');
      textarea.value = str;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      showCopyNotification('Top Right copied: ' + str);
    }
    function copyBottomLeft(xmin, ymin) {
      var str = xmin + '/' + ymin;
      var textarea = document.createElement('textarea');
      textarea.value = str;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand('copy');
      document.body.removeChild(textarea);
      showCopyNotification('Bottom Left copied: ' + str);
    }
    function showCopyNotification(msg) {
      var notification = document.createElement('div');
      notification.textContent = msg;
      notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 10px 15px; border-radius: 5px; z-index: 10000; font-size: 14px;';
      document.body.appendChild(notification);
      setTimeout(function() {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 2000);
    }
    </script>
    
    <!-- Footer with Logo and Copyright -->
    <div class="header-footer">
        <div class="logo-section">
            <div class="logo">
                <img src="{{ url_for('static', filename='rocket.jpg') }}" alt="Rocket Logo" style="width: 36px; height: 36px; object-fit: contain; border-radius: 50%; background: white;">
            </div>
            <div class="company-info">
                <strong>ARCgis PRO DataBase</strong><br>
                <span style="font-size: 11px;">◊§◊®◊ï◊ô◊ô◊ß◊ò ◊©◊ô◊û◊ï◊® ◊î◊ô◊ì◊¢ ◊©◊ú (◊†◊ï◊°◊ô◊£ ◊©◊ô◊™◊ê◊§◊©◊®)</span><br>
                <span class="copyright">@Rocket Team Production</span>
            </div>
        </div>

    </div>
</body>
</html>